name: Complete Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

      terraform_action:
        description: 'Terraform action (plan/apply)'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: 'plan'

      auto_approve:
        description: 'Auto-approve Terraform apply (required for apply)'
        required: true
        type: boolean
        default: false

      image_tag:
        description: 'Docker image tag (leave empty for auto-generated)'
        required: false
        type: string
        default: ''

      skip_infrastructure:
        description: 'Skip infrastructure deployment'
        required: false
        type: boolean
        default: false

      skip_monitoring:
        description: 'Skip monitoring deployment'
        required: false
        type: boolean
        default: false

      deploy_application:
        description: 'Deploy application after infrastructure'
        required: false
        type: boolean
        default: true

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'eu-central-1' }}

jobs:
  # Job 1: Deploy Infrastructure (if not skipped and action is apply)
  infrastructure:
    name: Deploy Infrastructure
    if: ${{ !inputs.skip_infrastructure && inputs.terraform_action == 'apply' }}
    uses: ./.github/workflows/deploy-infrastructure.yml
    with:
      environment: ${{ inputs.environment }}
      terraform_action: ${{ inputs.terraform_action }}
      auto_approve: ${{ inputs.auto_approve }}
    secrets: inherit

  # Job 2: Deploy Application (after infrastructure, if requested)
  application:
    name: Deploy Application
    needs: [infrastructure]
    if: |
      always() &&
      inputs.deploy_application &&
      (needs.infrastructure.result == 'success' || inputs.skip_infrastructure)
    uses: ./.github/workflows/deploy-application.yml
    with:
      environment: ${{ inputs.environment }}
      image_tag: ${{ inputs.image_tag }}
    secrets: inherit

  # Job 3: Deploy Monitoring (after application, if not skipped)
  monitoring:
    name: Deploy Monitoring
    needs: [application]
    if: |
      always() &&
      !inputs.skip_monitoring &&
      (needs.application.result == 'success' || !inputs.deploy_application)
    uses: ./.github/workflows/deploy-monitoring.yml
    with:
      cluster_name: ${{ needs.application.outputs.cluster-name || '' }}
      aws_region: ${{ env.AWS_REGION }}
    secrets: inherit

  # Job 4: Deployment Summary
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [infrastructure, application, monitoring]
    if: always()

    steps:
      - name: Generate Deployment Summary
        run: |
          echo "# üöÄ Complete Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Infrastructure status
          if [ "${{ inputs.skip_infrastructure }}" == "true" ]; then
            echo "| Infrastructure | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.infrastructure.result }}" == "success" ]; then
            echo "| Infrastructure | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.infrastructure.result }}" == "failure" ]; then
            echo "| Infrastructure | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Infrastructure | ‚è∏Ô∏è Not Run |" >> $GITHUB_STEP_SUMMARY
          fi

          # Application status
          if [ "${{ inputs.deploy_application }}" == "false" ]; then
            echo "| Application | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.application.result }}" == "success" ]; then
            echo "| Application | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.application.result }}" == "failure" ]; then
            echo "| Application | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Application | ‚è∏Ô∏è Not Run |" >> $GITHUB_STEP_SUMMARY
          fi

          # Monitoring status
          if [ "${{ inputs.skip_monitoring }}" == "true" ]; then
            echo "| Monitoring | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.monitoring.result }}" == "success" ]; then
            echo "| Monitoring | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.monitoring.result }}" == "failure" ]; then
            echo "| Monitoring | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Monitoring | ‚è∏Ô∏è Not Run |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Access Information
          if [ "${{ needs.application.result }}" == "success" ] || [ "${{ needs.monitoring.result }}" == "success" ]; then
            echo "## üåê Access Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Get Ingress LoadBalancer URL
            INGRESS_LB=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
              -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || \
              kubectl get svc -n ingress-nginx ingress-nginx-controller \
              -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")

            if [ "$INGRESS_LB" != "pending" ]; then
              echo "### üîó Ingress LoadBalancer" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Base URL:** http://$INGRESS_LB" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
              echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
              echo "| üìä Grafana | http://$INGRESS_LB/grafana |" >> $GITHUB_STEP_SUMMARY
              echo "| üìà Prometheus | http://$INGRESS_LB/prometheus |" >> $GITHUB_STEP_SUMMARY
              echo "| üíæ VictoriaMetrics | http://$INGRESS_LB/victoria |" >> $GITHUB_STEP_SUMMARY
              echo "| üö® AlertManager | http://$INGRESS_LB/alertmanager |" >> $GITHUB_STEP_SUMMARY
              echo "| üîç Tempo | http://$INGRESS_LB/tempo |" >> $GITHUB_STEP_SUMMARY
              echo "| üêù Locust | http://$INGRESS_LB/locust |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Grafana Credentials:** admin / (check GitHub secrets)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üí∞ **Cost Savings:** Using 1 Ingress LoadBalancer saves ~\$90/month" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Status:** ‚è≥ LoadBalancer provisioning..." >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo "# Check status with:" >> $GITHUB_STEP_SUMMARY
              echo "kubectl get svc -n ingress-nginx ingress-nginx-controller -w" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "# Get access URLs:" >> $GITHUB_STEP_SUMMARY
              echo "./observability.sh url" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Next Steps
          echo "## üìã Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.infrastructure.result }}" == "success" ] && [ "${{ needs.application.result }}" == "success" ]; then
            echo "1. ‚úÖ Access the Locust Web UI using the URL above" >> $GITHUB_STEP_SUMMARY
            echo "2. ‚úÖ Configure your load test parameters" >> $GITHUB_STEP_SUMMARY
            echo "3. ‚úÖ Start your load test" >> $GITHUB_STEP_SUMMARY
            echo "4. ‚úÖ Monitor metrics in Grafana dashboards" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.infrastructure.result }}" == "failure" ]; then
            echo "1. ‚ùå Review infrastructure deployment logs" >> $GITHUB_STEP_SUMMARY
            echo "2. ‚ùå Fix any Terraform errors" >> $GITHUB_STEP_SUMMARY
            echo "3. ‚ùå Re-run the deployment" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.application.result }}" == "failure" ]; then
            echo "1. ‚ùå Review application deployment logs" >> $GITHUB_STEP_SUMMARY
            echo "2. ‚ùå Check Docker build and Kubernetes manifests" >> $GITHUB_STEP_SUMMARY
            echo "3. ‚ùå Re-run the deployment" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Cleanup reminder
          echo "## üßπ Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "When done testing, destroy resources to avoid costs:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Actions** ‚Üí **Deploy Infrastructure**" >> $GITHUB_STEP_SUMMARY
          echo "2. Select **Run workflow**" >> $GITHUB_STEP_SUMMARY
          echo "3. Set **terraform_action** to **destroy**" >> $GITHUB_STEP_SUMMARY
          echo "4. Set **auto_approve** to **true**" >> $GITHUB_STEP_SUMMARY
          echo "5. Click **Run workflow**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Cost estimate
          echo "## üí∞ Cost Estimate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Estimated monthly cost for ${{ inputs.environment }} environment:" >> $GITHUB_STEP_SUMMARY
          echo "- EKS Control Plane: ~\$73/month" >> $GITHUB_STEP_SUMMARY
          echo "- Worker Nodes: ~\$60/month (2x t3.medium)" >> $GITHUB_STEP_SUMMARY
          echo "- NAT Gateways: ~\$65/month" >> $GITHUB_STEP_SUMMARY
          echo "- Monitoring Storage: ~\$6/month" >> $GITHUB_STEP_SUMMARY
          echo "- **Total: ~\$204/month**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° Destroy resources when not in use to save costs!" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        run: |
          INFRA_STATUS="${{ needs.infrastructure.result }}"
          APP_STATUS="${{ needs.application.result }}"
          MON_STATUS="${{ needs.monitoring.result }}"

          # Check if any critical deployment failed
          if [[ "$INFRA_STATUS" == "failure" ]] || [[ "$APP_STATUS" == "failure" ]]; then
            echo "‚ùå Deployment failed - check logs above"
            exit 1
          fi

          # Warning if monitoring failed but app succeeded
          if [[ "$MON_STATUS" == "failure" ]] && [[ "$APP_STATUS" == "success" ]]; then
            echo "‚ö†Ô∏è Application deployed but monitoring setup failed"
            exit 0
          fi

          echo "‚úÖ Deployment completed successfully!"
